name: Check for unsafeFlags

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  dump-package-check:
    name: Dump Swift package (authoritative) and scan JSON
    runs-on: ubuntu-latest
    container:
      image: swift:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dump package JSON and check for unsafeFlags
        run: |
          set -euo pipefail
          # Ensure we have a clean workspace
          swift --version || true
          swift package dump-package > package.json
          if grep -q '"unsafeFlags"' package.json; then
            echo "ERROR: unsafeFlags found in resolved package JSON:"
            grep -n '"unsafeFlags"' package.json || true
            echo "--- package.json ---"
            sed -n '1,200p' package.json || true
            exit 1
          else
            echo "No unsafeFlags in resolved package JSON."
          fi
